#!/bin/sh
# shellcheck disable=SC2181
# shellcheck disable=SC2034

builddir=@abs_builddir@
srcdir=@abs_srcdir@

usage() {
    echo "$0 --test-name=NAME --log-file=PATH.log --trs-file=PATH.trs --color-tests={yes|no} --expect-failure={yes|no} --enable-hard-errors={yes|no}"
}

TEST_NAME=
LOG_FILE=
TRS_FILE=
COLOR_TESTS=yes
EXPECT_FAILURE=no
HARD_ERRORS=yes

while getopts -: OPT; do
	if [ "$OPT" = "-" ] && [ -n "$OPTARG" ]; then
		OPT="${OPTARG%%=*}"
		OPTARG="${OPTARG#$OPT}"
		OPTARG="${OPTARG#=}"
	fi
	case "$OPT" in
		test-name) TEST_NAME="$OPTARG" ;;
		log-file) LOG_FILE="$OPTARG" ;;
		trs-file) TRS_FILE="$OPTARG" ;;
		color-tests) COLOR_TESTS="$OPTARG" ;;
		expect-failure) EXPECT_FAILURE="$OPTARG" ;;
		hard-errors) HARD_ERRORS="$OPTARG" ;;
		*) break ;;
	esac
done
shift $((OPTIND-1))

if [ -z "$1" ]; then
    echo "fatal: test name required"
    usage
    exit 1
fi

TEST_PROGRAM="$1"
shift

if [ -z "$TEST_NAME" ]; then
    TEST_NAME="$(basename "$TEST_PROGRAM")"
fi
if [ -z "$LOG_FILE" ]; then
    LOG_FILE="$TEST_PROGRAM.log"
fi
if [ -z "$TRS_FILE" ]; then
    TRS_FILE="$TEST_PROGRAM.trs"
fi

echo "Running $TEST_PROGRAM"

"${builddir}/run.sh" -p "$("${srcdir}/get_base_port.sh")" "$@" "$TEST_PROGRAM"

exit $?
